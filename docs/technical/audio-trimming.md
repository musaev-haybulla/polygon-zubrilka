# Техническая спецификация: Обрезка аудиофайлов

## Обзор
Система обрезки позволяет пользователю выбрать нужный фрагмент аудиофайла через waveform-интерфейс и создать его урезанную версию, сохранив при этом оригинал для возможности отката.

## Логика процесса

### 1. Состояние до обрезки
- **Файловая система:** В директории озвучки (например, `uploads/audio/{poem_id}/`) лежит один файл, например `audio.mp3`.
- **База данных (таблица `audio_tracks`):**
    - `filename`: 'audio.mp3'
    - `original_filename`: NULL
    - `duration`: (длительность `audio.mp3`)

### 2. Процесс обрезки
1.  **Интерфейс:** Пользователь в waveform-редакторе выбирает начальное (`start_time`) и конечное (`end_time`) время для нового фрагмента.
2.  **Сервер (Бэкенд):**
    - Получает ID озвучки, `start_time` и `end_time`.
    - **Проверяет** корректность данных (файл существует, `start_time` < `end_time`).
    - **Формирует имена:**
        - Имя оригинального файла остается прежним.
        - Имя для нового, обрезанного файла генерируется на основе оригинального (например, `audio-trimmed.mp3`).
    - **Выполняет обрезку:** С помощью **FFmpeg** из исходного файла создается новый, обрезанный файл.
        ```bash
        ffmpeg -i "исходный_файл.mp3" -ss [start_time] -to [end_time] -c copy "обрезанный_файл.mp3"
        ```
    - **Обновляет базу данных:**
        - `filename` теперь указывает на новый, обрезанный файл (`audio-trimmed.mp3`).
        - `original_filename` сохраняет имя исходного файла (`audio.mp3`).
        - `duration` пересчитывается и устанавливается равным `end_time - start_time`.

### 3. Состояние после обрезки
- **Файловая система:** В директории озвучки теперь два файла:
    - `audio.mp3` (оригинал)
    - `audio-trimmed.mp3` (активная, обрезанная версия)
- **База данных:**
    - `filename`: 'audio-trimmed.mp3'
    - `original_filename`: 'audio.mp3'
    - `duration`: (длительность обрезанного фрагмента)

## Ключевые операции

### Вычисление длительности
- Длительность аудиофайла должна получаться с помощью **FFprobe**. Это гарантирует точность.
    ```bash
    ffprobe -i "файл.mp3" -show_entries format=duration -v quiet -of csv="p=0"
    ```
- Поле `duration` в базе данных **всегда** отражает длительность файла, указанного в поле `filename`.

### Откат к оригиналу
- Пользователь может отменить обрезку и вернуться к исходной версии аудио.
- **Процесс отката:**
    1.  **Обновление БД:**
        - Значение из `original_filename` копируется в `filename`.
        - `original_filename` устанавливается в `NULL`.
        - `duration` пересчитывается для оригинального файла.
    2.  **Очистка ФС:** Обрезанный файл (`audio-trimmed.mp3`) удаляется.

## Требования к безопасности и обработке ошибок
- **Валидация:** Всегда проверять входные данные от пользователя (ID, временные метки).
- **Доступность FFmpeg:** Система должна проверять наличие FFmpeg/FFprobe на сервере.
- **Транзакционность:** В случае ошибки при выполнении команды `ffmpeg` (например, некорректные временные метки), необходимо удалить любые созданные артефакты (пустые или частично обрезанные файлы) и не вносить изменений в базу данных. Пользователю должно быть возвращено информативное сообщение об ошибке.
