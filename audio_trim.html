<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Аудио Обрезка - Bootstrap Interface</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #waveform {
      width: 100%;
      border: 1px solid #dee2e6;
      border-radius: .25rem;
      margin-bottom: 1rem;
    }
    .region-timeline span {
      font-weight: 500;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5" x-data="audioTrimmer">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Аудио Обрезка</h5>
      </div>
      <div class="card-body">
        <!-- Waveform -->
        <div id="waveform"></div>
        <!-- Region Timeline Info -->
        <div class="row text-center mb-3 region-timeline">
          <div class="col">
            <div>Start: <span x-text="formatTime(regionStartVal)"></span> сек</div>
          </div>
          <div class="col">
            <div>Duration: <span x-text="formatTime(regionDurationVal)"></span> сек</div>
          </div>
          <div class="col">
            <div>End: <span x-text="formatTime(regionEndVal)"></span> сек</div>
          </div>
        </div>
        <!-- Controls -->
        <div class="d-flex justify-content-center flex-wrap gap-2">
          <button class="btn btn-success" @click="togglePlayPause" x-text="isPlaying ? 'Пауза' : 'Плей'"></button>
          <button class="btn btn-info" @click="playFirst2Seconds">Проиграть первые 2 секунды</button>
          <button class="btn btn-warning" @click="playLast2Seconds">Проиграть последние 2 секунды</button>
          <button class="btn btn-danger" @click="finish">Завершить</button>
        </div>
      </div>
      <div class="card-footer text-muted text-center">
        © 2023 Audio Trimmer
      </div>
    </div>
  </div>

  <!-- Alpine.js, Wavesurfer.js с плагином Regions и Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/wavesurfer.js@7"></script>
  <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('audioTrimmer', () => ({
        wavesurfer: null,
        wsRegions: null,
        region: null,
        isPlaying: false,
        totalDuration: 0,
        
        // Реактивные переменные для отображения меток региона
        regionStartVal: 0,
        regionEndVal: 0,
        regionDurationVal: 0,
        
        // Переменная для хранения таймера воспроизведения
        playTimeout: null,
        
        init() {
          this.initWaveSurfer();
        },
        
        initWaveSurfer() {
          this.wsRegions = WaveSurfer.Regions.create();
          this.wavesurfer = WaveSurfer.create({
            container: '#waveform',
            backend: 'WebAudio',
            plugins: [this.wsRegions]
          });
          
          this.wavesurfer.load('audio.mp3');
          
          this.wavesurfer.on('ready', () => {
            this.totalDuration = this.wavesurfer.getDuration();
            this.region = this.wsRegions.addRegion({
              start: 0,
              end: this.totalDuration,
              color: 'rgba(0, 0, 0, 0.02)',
              drag: true,
              resize: true
            });
            
            // Изначальное выставление реактивных значений
            this.regionStartVal = this.region.start;
            this.regionEndVal = this.region.end;
            this.regionDurationVal = this.region.end - this.region.start;
            
            // Обновление меток после изменения региона
            this.region.on('update-end', () => {
              this.regionStartVal = this.region.start;
              this.regionEndVal = this.region.end;
              this.regionDurationVal = this.region.end - this.region.start;
            });
          });
          
          // Ограничение воспроизведения выбранным регионом
          this.wavesurfer.on('timeupdate', () => {
            if (this.region && this.isPlaying) {
              const currentTime = this.wavesurfer.getCurrentTime();
              if (currentTime >= this.region.end) {
                this.wavesurfer.stop();
                this.isPlaying = false;
                this.wavesurfer.setTime(this.region.start);
              }
            }
          });
          
          this.wavesurfer.on('finish', () => {
            this.isPlaying = false;
          });
        },
        
        togglePlayPause() {
          if (this.isPlaying) {
            this.wavesurfer.pause();
            this.isPlaying = false;
            if (this.playTimeout) {
              clearTimeout(this.playTimeout);
              this.playTimeout = null;
            }
          } else {
            const currentTime = this.wavesurfer.getCurrentTime();
            if (this.region && (currentTime < this.region.start || currentTime > this.region.end)) {
              this.wavesurfer.setTime(this.region.start);
            }
            this.wavesurfer.play();
            this.isPlaying = true;
          }
        },
        
        playFirst2Seconds() {
          if (!this.region) return;
          if (this.playTimeout) {
            clearTimeout(this.playTimeout);
            this.playTimeout = null;
          }
          const start = this.region.start;
          const desiredEnd = Math.min(start + 2, this.region.end);
          this.wavesurfer.setTime(start);
          this.wavesurfer.play();
          this.isPlaying = true;
          this.playTimeout = setTimeout(() => {
            this.wavesurfer.pause();
            this.isPlaying = false;
            this.wavesurfer.setTime(this.region.start);
          }, (desiredEnd - start) * 1000);
        },
        
        playLast2Seconds() {
          if (!this.region) return;
          if (this.playTimeout) {
            clearTimeout(this.playTimeout);
            this.playTimeout = null;
          }
          const end = this.region.end;
          const start = Math.max(this.region.start, end - 2);
          this.wavesurfer.setTime(start);
          this.wavesurfer.play();
          this.isPlaying = true;
          this.playTimeout = setTimeout(() => {
            this.wavesurfer.pause();
            this.isPlaying = false;
            // Возвращаем каретку в начало всего региона
            this.wavesurfer.setTime(this.region.start);
          }, (end - start) * 1000);
        },
        
        finish() {
          console.log('Завершено. Выбранный отрезок:', {
            start: this.formatTime(this.regionStartVal),
            end: this.formatTime(this.regionEndVal),
            duration: this.formatTime(this.regionDurationVal)
          });
          alert(
            'Выбранный отрезок:\n' +
            'Начало: ' + this.formatTime(this.regionStartVal) + ' сек.\n' +
            'Конец: ' + this.formatTime(this.regionEndVal) + ' сек.\n' +
            'Длительность: ' + this.formatTime(this.regionDurationVal) + ' сек.'
          );
        },
        
        formatTime(time) {
          return parseFloat(Number(time).toFixed(2));
        }
      }));
    });
  </script>
</body>
</html>